# Bug修复：自定义知识卡模板问题

## 问题描述

当用户创建自定义知识卡模板并生成卡片时，出现以下问题：
1. 显示错误："没有可用问题"
2. 弹出了"问答卡"窗口，而不是"知识卡"窗口
3. 自定义选择题和问答题模板工作正常，只有知识卡有问题

## 根本原因

在 `gui/controllers/question_controller.py` 的 `on_questions_generated()` 方法中，判断应该打开哪个窗口的逻辑有误：

### 旧代码逻辑（错误）：
```python
# 根据UI上选择的问题类型来判断
question_type = self.dialog.ui.questionTypeComboBox.currentText()
if question_type == get_message("question_type_knowledge", self.dialog.lang) or \
   question_type == get_message("question_type_language_learning", self.dialog.lang):
    # 打开知识卡窗口
else:
    # 打开问答卡窗口
```

**问题**：
- 当用户选择"自定义模板"时，`question_type` 的值是 "自定义模板"
- 这个值既不等于 "知识卡"，也不等于 "语言学习知识卡"
- 因此即使自定义模板生成的是知识卡数据，也会走到 `else` 分支
- 结果打开了 `ReviewDialog`（问答卡窗口）而不是 `KnowledgeCardWindow`

### 数据结构差异

不同类型的卡片返回的数据结构不同：

**知识卡**：
```json
{
    "cards": [
        {
            "question": "问题",
            "answer": "答案",
            "context": "上下文"
        }
    ]
}
```

**选择题/问答题**：
```json
{
    "questions": [
        {
            "question": "问题",
            ...
        }
    ]
}
```

## 解决方案

修改判断逻辑，**根据返回数据的实际结构**来决定打开哪个窗口，而不是根据UI上选择的类型：

### 新代码逻辑（正确）：
```python
# 根据返回数据的结构判断应该打开哪个窗口
# 知识卡的数据结构包含 'cards' 字段，而选择题和问答题包含 'questions' 字段
is_knowledge_card = isinstance(questions, dict) and 'cards' in questions

if is_knowledge_card:
    # 打开知识卡窗口
else:
    # 打开问答卡窗口（选择题和问答题）
```

**优点**：
1. ✅ 不依赖UI选择，而是依赖实际数据
2. ✅ 自动适配所有生成知识卡的场景（内置模板、自定义模板）
3. ✅ 更加健壮，不会因为UI文本变化而失效
4. ✅ 符合"鸭子类型"原则：如果数据像知识卡，就当知识卡处理

## 修改的文件

### `gui/controllers/question_controller.py`

**修改位置**：第 28-85 行，`on_questions_generated()` 方法

**修改内容**：
- 移除了基于UI文本的判断逻辑
- 添加了基于数据结构的判断逻辑
- 更新了注释，说明判断依据

## 测试验证

### 测试场景 1：自定义知识卡模板
1. 创建自定义模板，选择类型为"知识卡"
2. 输入提示词
3. 生成卡片
4. **预期结果**：打开知识卡窗口，显示生成的知识卡
5. **实际结果**：✅ 正确打开知识卡窗口

### 测试场景 2：自定义选择题模板
1. 创建自定义模板，选择类型为"选择题"
2. 输入提示词
3. 生成卡片
4. **预期结果**：打开问答卡窗口，显示选择题
5. **实际结果**：✅ 正确打开问答卡窗口

### 测试场景 3：自定义问答题模板
1. 创建自定义模板，选择类型为"问答题"
2. 输入提示词
3. 生成卡片
4. **预期结果**：打开问答卡窗口，显示问答题
5. **实际结果**：✅ 正确打开问答卡窗口

### 测试场景 4：内置知识卡模板
1. 选择内置的"知识卡"类型
2. 生成卡片
3. **预期结果**：打开知识卡窗口
4. **实际结果**：✅ 正确打开知识卡窗口（向后兼容）

## 影响范围

- ✅ 修复了自定义知识卡模板无法正常使用的问题
- ✅ 不影响现有的内置模板功能
- ✅ 不影响自定义选择题和问答题模板
- ✅ 提高了代码的健壮性和可维护性

## 相关问题

这个bug的根源在于：
1. 自定义模板功能是后来添加的
2. 原有的窗口选择逻辑假设"问题类型"和"UI选择"是一一对应的
3. 自定义模板打破了这个假设（一个UI选项对应多种实际类型）

通过这次修复，代码变得更加灵活，能够自动适应未来可能添加的新类型。

