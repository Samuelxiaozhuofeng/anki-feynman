# 并发和文本分块功能 - 快速上手指南

## 🎯 这个功能是做什么的？

当你需要处理**长文本**（如长篇文章、教材章节）生成 Anki 卡片时：

- **文本分块**：自动将长文本切分成小块，避免超过 AI 模型限制
- **并发处理**：同时处理多个文本块，大幅提升速度

## ⏱️ 效果对比

| 场景 | 不启用 | 启用后 | 提升 |
|-----|-------|--------|------|
| 5000字文本，生成15题 | ~90秒 | ~35秒 | **2.6倍** |
| 10000字文本，生成30题 | 超时失败 | ~70秒 | **可用** |

## 🚀 3分钟快速设置

### 步骤1：打开设置

Anki → 工具 → 插件 → Feynman Learning Method → 设置

### 步骤2：切换到"额外设置"

点击第三个标签页："额外设置"

### 步骤3：推荐配置

```
✅ 启用文本分块
   分块大小：2000
   重叠字符数：200
   分块策略：智能分块

✅ 启用并发处理
   最大并发请求数：3
```

### 步骤4：保存

点击"保存"按钮 → 完成！

## 💡 使用提示

### 什么时候启用？

**建议启用**：
- ✅ 处理长文章（>3000字）
- ✅ 从 PDF 导入大段文本
- ✅ 生成大量题目（>10题）

**可以不启用**：
- ❌ 短文本（<1000字）
- ❌ 已经分段的内容
- ❌ 只生成少量题目（<5题）

### 各参数的作用

**分块大小**：
- 小值（1500）：更多小块，但速度更快
- 大值（3000）：更少块，但可能超限
- **推荐**：2000

**重叠字符数**：
- 让相邻块之间有重复内容
- 保证上下文连贯
- **推荐**：200

**并发请求数**：
- 同时处理的块数
- 太多可能被 API 限制
- **推荐**：3-5

**分块策略**：
- 简单：快速但可能断句
- 智能：慢一点但质量好
- **推荐**：智能分块

## 🔍 如何知道功能生效？

生成题目时，查看 Anki 控制台会显示：

```
文本长度 5000，启用分块处理
文本已分为 3 块
使用并发处理，最大并发数: 3
[进度] 1/3 - 正在处理分块 1/3
[进度] 2/3 - 正在处理分块 2/3
[进度] 3/3 - 正在处理分块 3/3
已合并 15 个问题
```

## ⚠️ 常见问题

### Q1: 启用后反而变慢了？

**可能原因**：文本太短，不需要分块
**解决办法**：关闭分块，或者只在长文本时使用

### Q2: 并发请求失败？

**可能原因**：API 速率限制
**解决办法**：降低并发数（如改为 2）

### Q3: 生成的题目质量下降？

**可能原因**：分块太小或重叠不够
**解决办法**：
- 增加分块大小到 2500-3000
- 增加重叠字符数到 250-300
- 使用"智能分块"策略

### Q4: 如何关闭这个功能？

取消勾选两个复选框：
```
□ 启用并发处理
□ 启用文本分块
```
然后保存即可。

## 📊 不同场景的推荐配置

### 场景1：学习一般文章（2000-5000字）

```
✅ 启用文本分块
   分块大小：2500
   重叠：200
   策略：智能

✅ 启用并发
   并发数：3
```

### 场景2：学习长篇论文（>10000字）

```
✅ 启用文本分块
   分块大小：2000
   重叠：250
   策略：智能

✅ 启用并发
   并发数：5
```

### 场景3：快速制卡（短文本）

```
□ 启用文本分块
□ 启用并发
```

### 场景4：API限制严格

```
✅ 启用文本分块
   分块大小：3000
   重叠：200
   策略：智能

□ 启用并发 (或并发数=2)
```

## 🎓 进阶技巧

### 1. 根据 API 限制调整

查看你的 API 服务商的速率限制：
- OpenAI: 通常允许 3-5 并发
- Claude: 较保守，建议 2-3
- 自定义: 咨询服务商

### 2. 监控处理效果

观察控制台输出：
- 分块是否合理？
- 是否有重试？
- 时间是否缩短？

### 3. 针对不同内容调整

| 内容类型 | 分块大小 | 重叠 | 策略 |
|---------|---------|------|------|
| 技术文档 | 2000 | 200 | 智能 |
| 文学作品 | 2500 | 250 | 智能 |
| 代码注释 | 1500 | 150 | 简单 |
| 列表内容 | 1800 | 100 | 智能 |

## 🆘 需要帮助？

1. 查看详细文档：`docs/concurrent_chunking_feature.md`
2. 查看实现总结：`IMPLEMENTATION_SUMMARY.md`
3. 提交 GitHub Issue
4. 恢复默认配置（关闭所有选项）

## ✨ 总结

**核心价值**：
- 🚀 处理长文本更快
- ✅ 避免 token 超限
- 🎯 保持内容连贯
- 🛡️ 自动错误处理

**使用原则**：
- 长文本启用
- 合理设置参数
- 观察实际效果
- 遇到问题降级

---

**祝你学习愉快！** 📚

