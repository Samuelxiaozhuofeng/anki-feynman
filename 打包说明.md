# Anki Feynman Learning 插件打包说明

## 快速开始

### 方法一：一键打包（推荐）

双击运行 `打包插件.bat` 文件即可自动打包。

### 方法二：手动运行

```bash
python build_addon.py
```

## 首次使用前的准备

**重要**：在首次打包前，需要先安装所有依赖库到 `vendor` 目录。

### 安装依赖

#### Windows 用户（推荐）

双击运行 `安装依赖.bat` 文件。

#### 手动安装

```bash
pip install -r requirements.txt -t vendor --upgrade
```

### 依赖列表

打包会包含以下依赖库：
- `openai==0.28.0` - OpenAI API 客户端
- `aiohttp>=3.8.0` - 异步 HTTP 客户端
- `async-timeout>=4.0.0` - 异步超时控制
- `requests>=2.20` - HTTP 请求库
- `tqdm>=4.0` - 进度条显示
- `pypdf>=3.0.0` - PDF 处理
- `typing_extensions>=4.0.0` - 类型扩展（Python 3.9 兼容性）

## 功能特性

### ✅ 自动打包
- 自动收集所有必要的文件和目录
- 包含所有依赖库（vendor目录）
- 生成标准的 .ankiaddon 文件

### 🔒 安全保护
- **自动排除敏感信息**：
  - `config.json` 中的 API keys 会被自动清空
  - `meta.json` 文件（包含用户配置）不会被打包
  
- **排除开发文件**：
  - `__pycache__` 和 `.pyc` 文件
  - `.git` 和 IDE 配置文件
  - 测试文件和临时文件
  - 日志文件

### 📦 打包内容

打包会包含以下内容：

```
anki_feynman_YYYYMMDD_HHMMSS.ankiaddon
├── __init__.py
├── manifest.json
├── config.json (已清理API keys)
├── config.md
├── config/
├── data/
├── docs/
├── gui/
├── lang/
├── prompts/
├── schemas/
├── utils/
└── vendor/ (所有依赖库)
```

## 输出文件

打包后的文件会保存在 `dist/` 目录下，文件名格式：

```
anki_feynman_YYYYMMDD_HHMMSS.ankiaddon
```

例如：`anki_feynman_20250114_153045.ankiaddon`

## 安装打包后的插件

1. 打开 Anki
2. 点击 **工具** -> **插件**
3. 点击 **从文件安装**
4. 选择生成的 `.ankiaddon` 文件
5. 重启 Anki

## 配置说明

### 修改打包内容

如需修改打包的文件，编辑 `build_addon.py` 中的配置：

```python
# 需要包含的文件和目录
INCLUDE_PATTERNS = [
    "__init__.py",
    "manifest.json",
    "config.json",
    # ... 添加更多文件或目录
]

# 需要排除的文件和目录
EXCLUDE_PATTERNS = [
    "__pycache__",
    "*.pyc",
    # ... 添加更多排除规则
]
```

### 添加敏感文件清理

如需清理其他文件中的敏感信息：

```python
SENSITIVE_FILES = {
    "config.json": ["ai_service.openai.api_key", "ai_service.custom.api_key"],
    # 添加其他需要清理的文件
    # "other_file.json": ["path.to.sensitive.field"],
}
```

## 常见问题

### Q: 打包后的文件太大？
A: 检查 `vendor/` 目录，确保只包含必要的依赖库。可以在 `EXCLUDE_PATTERNS` 中添加不需要的文件。

### Q: 如何验证 API key 已被清除？
A: 解压生成的 `.ankiaddon` 文件（它实际上是 zip 格式），检查 `config.json` 文件中的 `api_key` 字段应该为空字符串。

### Q: 打包失败怎么办？
A: 
1. 检查 Python 版本（需要 3.7+）
2. 确保所有必要的文件都存在
3. 查看错误信息，根据提示修复问题

### Q: 如何在其他电脑上使用？
A: 将生成的 `.ankiaddon` 文件复制到其他电脑，按照安装步骤安装即可。首次使用时需要在设置中配置 API key。

## 技术细节

- `.ankiaddon` 文件实际上是 ZIP 格式的压缩包
- 使用 `zipfile.ZIP_DEFLATED` 压缩算法
- 自动处理 UTF-8 编码
- 保留文件的修改时间等元数据

## 开发建议

1. **打包前测试**：在打包前确保插件在本地运行正常
2. **版本管理**：更新 `manifest.json` 中的版本号
3. **备份配置**：打包会清除 API keys，确保你有备份
4. **测试安装**：在干净的 Anki 环境中测试安装包

## 许可证

本打包脚本遵循与主项目相同的许可证。

